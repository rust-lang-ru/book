# Основы несогласованного программирования: Async, Await, Futures и Потоки

Многие действия, которые мы просим выполнить компьютер, могут занять некоторое время. Было бы
хорошо, если бы мы могли заняться чем-то другим, пока ждем завершения этих
длительных этапов. Современные компьютеры предлагают два способа для
работы с более чем одной операцией одновременно: одновременность и многопоточность. Как только
мы начинаем писать приложения, включающие одновременные или многопоточные действия,
мы быстро сталкиваемся с новыми сложностями, присущими _несогласованному
программированию_, когда действия могут не завершаться последовательно в том порядке, в котором они
были начаты. Эта глава основывается на использовании потоков для одновременности
и одновременности в Главе 16, представляя иной подход к несогласованному
программированию: фьючерсы Ржавчины, потоки, правила написания `async` и `await`,
которые их поддерживают, и средства для управления и взаимодействия между несогласованными
действиями.

Давайте рассмотрим пример. Допустим, вы экспортируете видео, которое вы создали
семейного торжества, действие, которая может занять от нескольких минут до нескольких часов.
Экспорт видео будет использовать всю возможную мощность ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ и ВИДЕО УСКОРИТЕЛЬ. Если у вас было только
одно ядро ​​ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ и ваша операционная система не остановила этот экспорт, пока он
не завершился — то есть если бы она выполняла экспорт _согласованно_ — вы не могли бы
делать ничего другого на своем компьютере, пока эта задача выполнялась. Это было бы
довольно
неприятным опытом. К счастью, операционная система вашего компьютера
может и делает это, незаметно прерывая экспорт достаточно часто, чтобы вы могли
одновременно выполнять другую работу.

Теперь предположим, что вы загружаете видео, которым поделился кто-то другой, что также может занять некоторое
время, но не занимает так много времени ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ. В этом случае ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ приходится ждать,
пока данные поступят из сети. Хотя вы можете начать читать данные,
как только они начнут поступать, может потребоваться некоторое время, чтобы все они отобразились. Даже если
все данные присутствуют, если видео достаточно большое, загрузка всего этого может занять не менее
секунды или двух. Это может показаться не таким уж большим, но это очень много времени для современного процессора, который может выполнять миллиарды действий в
секунду. Опять же, ваша операционная система будет незаметно прерывать вашу программу, чтобы позволить ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ выполнить другую работу, ожидая завершения сетевого вызова.

Экспорт видео является примером действия, _связанной_ с ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ или _связанной_ с вычислениями.
Она ограничена имеющейся скоростью обработки данных компьютера в ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ или ВИДЕО УСКОРИТЕЛЬ и тем, какую часть этой скорости он может выделить на действие. Загрузка видео является примером действия, _связанной_ с вводом-выводом, поскольку она ограничена скоростью ввода-вывода компьютера; она может выполняться только с той скоростью, с которой
могут быть отправлены данные по сети.

В обоих этих примерах невидимые прерывания операционной системы обеспечивают
вид одновременности. Однако эта одновременность происходит только на уровне всей
приложения: операционная система прерывает одну программу, чтобы позволить другим
приложением выполнить работу. Во многих случаях, поскольку мы понимаем наши приложения на
гораздо более подробном уровне, чем операционная система, мы можем обнаружить
возможности для одновременности, которые операционная система не видит.

Например, если мы создаем средство для управления загрузками файлов, мы должны иметь
возможность написать нашу программу так, чтобы запуск одной загрузки не блокировал пользовательский интерфейс,
и пользователи должны иметь возможность запускать несколько загрузок одновременно. Однако многие
API операционной системы для взаимодействия с сетью являются _блокирующими_;
то есть они блокируют ход выполнения приложения до тех пор, пока данные, которые они обрабатывают,
не будут полностью готовы.

> Примечание: именно так работают _большинство_ вызовов способов (функций), если задуматься. Однако,
> термин _блокировка_ обычно зарезервирован для вызовов способов (функций), которые взаимодействуют с
> файлами, сетью или другими ресурсами на компьютере, потому что это
> случаи, когда отдельная приложение выиграет от действия, которая
> _не блокируется_.

Мы могли бы избежать блокировки нашего основного потока, создав выделенный поток для загрузки каждого файла. 
Однако накладные расходы этих потоков в конечном итоге станут сложностью. Было бы предпочтительнее, если бы вызов не блокировался изначально. 
Также было бы лучше, если бы мы могли писать в том же прямом виде, который мы используем
в блокирующем коде, например так:

```Rust,ignore,does_not_compile
let данные = fetch_data_from(ссылка).await;
println!("{данные}");
```

то именно то, что дает нам абстракция Ржавчина _async_ (сокращение от _asynchronous_). 
В этой главе вы узнаете все об несогласованности, поскольку мы рассмотрим следующие
темы:

- Как использовать правила написания `async` и `await` Ржавчина
- Как использовать средство async для решения некоторых из тех же проблем, которые мы рассматривали
в Главе 16
- Как многопоточность и async предоставляют взаимодополняющие решения, которые вы можете
комбинировать во многих случаях

Однако прежде чем мы увидим, как несогласованность работает в действительности, нам нужно сделать небольшое отступление и обсудить различия между одновременностью и состязательностью.

### Одновременность и многопоточность

До сих пор мы считали одновременность и многопоточность взаимозаменяемыми. Теперь
нам нужно различать их более точно, потому что различия
проявятся, когда мы начнем работать.

Рассмотрите различные способы, которыми приказ может разделить работу над программным проектом.
Вы можете назначить одному участнику несколько задач, назначить каждому участнику одну задачу или
использовать сочетание двух подходов.

Когда человек работает над несколькими разными задачами, прежде чем любая из них
завершена, это _одновременность_. Возможно, у вас на компьютере есть два разных проекта, и когда вам становится скучно или вы застреваете на одном проекте, вы переключаетесь
на другой. Вы всего лишь один человек, поэтому вы не можете добиться выполнения в обеих задачах
одновременно, но вы можете выполнять несколько задач одновременно, достигая выполнения в одной за раз,
переключаясь между ними (см. Рисунок 17-1).

<figure>

<img src="img/trpl17-01.svg" class="center" alt="Диаграмма с полями, обозначенными как Задача A и Задача B, с ромбами в них, представляющими подзадачи. Стрелки направлены от A1 к B1, от B1 к A2, от A2 к B2, от B2 к A3, от A3 к A4 и от A4 к B3. Стрелки между подзадачами пересекают поля между Задачей A и Задачей B." />

<figcaption>Рисунок 17-1: Одновременный рабочий этап, переключение между задачей A и задачей B</figcaption>

</figure>

Когда приказ разделяет группу задач, заставляя каждого члена брать одну задачу и работать над ней в одиночку, это _одновременность_. Каждый человек в команде может добиться
выполнения в одно и то же время (см. Рисунок 17-2).

<figure>

<img src="img/trpl17-02.svg" class="center" alt="Диаграмма с полями, обозначенными как Задача A и Задача B, с ромбами в них, представляющими подзадачи. Стрелки направлены от A1 к A2, от A2 к A3, от A3 к A4, от B1 к B2 и от B2 к B3. Между полями для Задачи A и Задачи B нет стрелок, пересекающихся." />

<figcaption>Рисунок 17-2: Одновременный рабочий этап, в котором работа над задачей A и задачей B выполняется независимо</figcaption>

</figure>

В обоих этих рабочих этапах вам, возможно, придется координировать различные
задачи. Возможно, вы _думали_, что задача, назначенная одному человеку, полностью
независима от работы всех остальных, но на самом деле она требует, чтобы другой человек в команде сначала завершил свою задачу. Часть работы можно было выполнять
одновременно, но часть была в действительности _последовательной_: она могла происходить только
в последовательности, одна задача за другой, как на рисунке 17-3.

<figure>

<img src="img/trpl17-03.svg" class="center" alt="Диаграмма с полями, обозначенными как Задача A и Задача B, с ромбами в них, представляющими подзадачи. Есть стрелки, указывающие от A1 к A2, от A2 к паре толстых вертикальных линий, как символ «паузы», от этого символа к A3, от B1 к B2, от B2 к B3, который находится под этим символом, от B3 к A3 и от B3 к B4." />

<figcaption>Рисунок 17-3: Частично одновременный рабочий этап, в котором работа над задачей A и задачей B выполняется независимо, пока задача A3 не будет заблокирована по итогам задачи B3.</figcaption>

</figure>

Также как, вы можете осознать, что одна из ваших задач зависит от другой. Теперь ваша одновременная работа также стала последовательной.

Многопоточность и одновременность также могут пересекаться друг с другом. Если вы узнаете,
что напарник застрял, пока вы не закончите одну из своих задач, вы, вероятно,
сосредоточите все свои усилия на этой задаче, чтобы «разблокировать» своего коллегу. Вы и ваш
напарник больше не можете работать одновременно, и вы также больше не можете
работать одновременно над своими собственными задачами.

Та же самая основная динамика вступает в игру с программным обеспечением и оборудованием. На машине
с одним ядром ядром, ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ может выполнять только одно действие за раз, но он
все еще может работать одновременно. Используя такие средства, как потоки, этапы и несогласованность,
компьютер может приостанавливать одно действие и переключаться на другие, прежде чем в конечном итоге
снова вернуться к этому первому действию. На машине с несколькими ядрами ГЛАВНЫЙ ВЫЧИСЛИТЕЛЬ он также может выполнять работу одновременно. Одно ядро ​​может выполнять одну задачу, пока
другое ядро ​​выполняет совершенно несвязанную задачу, и эти действия в действительности
происходят одновременно.

Работая с несогласованностью в Ржавчине, мы всегда имеем дело с одновременностью.

В зависимости от оборудования, операционной системы и несогласованной среды выполнения,
которую мы используем (подробнее об несогласованных средах выполнения вскоре), эта одновременность может также использовать одновременность
под капотом.

Теперь давайте углубимся в то, как на самом деле работает несогласованное программирование в Ржавчине.
